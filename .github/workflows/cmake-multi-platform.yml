name: Build TDLib for Windows

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout TDLib source
        uses: actions/checkout@v4
        with:
          repository: tdlib/td
          path: td
          ref: master

      - name: Clone vcpkg
        run: |
          cd td
          git clone https://github.com/Microsoft/vcpkg.git

      - name: Checkout specific vcpkg version
        run: |
          cd td/vcpkg
          git checkout bc3512a509f9d29b37346a7e7e929f9a26e66c7e

      - name: Bootstrap vcpkg
        run: |
          cd td/vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install dependencies via vcpkg
        run: |
          cd td/vcpkg
          .\vcpkg.exe install gperf:x64-windows openssl:x64-windows zlib:x64-windows

      - name: Clean and create build directory
        run: |
          cd td
          Remove-Item build -Force -Recurse -ErrorAction SilentlyContinue
          mkdir build

      - name: Configure CMake with vcpkg
        run: |
          cd td/build
          cmake -A x64 -DCMAKE_INSTALL_PREFIX:PATH=../tdlib -DCMAKE_TOOLCHAIN_FILE:FILEPATH=../vcpkg/scripts/buildsystems/vcpkg.cmake ..

      - name: Build and install TDLib
        run: |
          cd td/build
          cmake --build . --target install --config Release

      - name: Package build artifacts
        run: |
          cd td/build
          tar -czf ../../tdlib-windows-x86_64.tar.gz tdlib/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-windows-x86_64
          path: td/tdlib-windows-x86_64.tar.gz
          retention-days: 30
